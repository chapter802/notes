
import React from 'react';
import coordtransform from 'coordtransform';

class BaiduMap extends React.Component {

    componentDidMount() {
        let BMap = window.BMap;

        let map = new BMap.Map("allmap"); // 创建Map实例
        let point = new BMap.Point(116.418261, 39.921984);
        map.centerAndZoom(new BMap.Point(116.404, 39.915), 11); // 初始化地图,设置中心点坐标和地图级别
        map.addControl(new BMap.MapTypeControl()); //添加地图类型控件
        map.setCurrentCity("北京"); // 设置地图显示的城市 此项是必须设置的
        map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放

        let  posOriginJson = {"34.6836,113.5325": {"count": 1553}, "37.419200000000004,-122.0574": {"count": 4431}, "41.7922,123.4328": {"count": 3196}, "36.6683,116.9972": {"count": 3150}, "42.8135,-70.886": {"count": 145}, "30.2936,120.1614": {"count": 42301}, "23.1167,113.25": {"count": 814}, "34.2583,108.9286": {"count": 3141}, "31.0456,121.3997": {"count": 1998}, "39.9289,116.3883": {"count": 7565}, "59.8944,30.2642": {"count": 65}, "48.8582,2.3387000000000002": {"count": 486}, "34.7725,113.7266": {"count": 861}, "38.0089,115.5481": {"count": 133}, "47.6801,-122.1206": {"count": 435}, "44.4795,-92.8727": {"count": 24}, "37.3388,-121.8914": {"count": 46}, "43.88,125.3228": {"count": 44}, "32.0617,118.7778": {"count": 1653}, "37.751,-97.822": {"count": 27}, "55.7386,37.6068": {"count": 42}, "-6.9782,110.4594": {"count": 1}, "48.15,11.5833": {"count": 7}, "47.2364,39.7139": {"count": 1}, "34.1716,-118.3216": {"count": 9}, "-4.5833,55.6667": {"count": 7}, "25.0389,102.7183": {"count": 685}, "39.1472,-94.5735": {"count": 142}, "36.0564,103.7922": {"count": 17}, "30.6667,104.0667": {"count": 1152}, "37.4249,-122.0074": {"count": 89}, "39.018,-77.539": {"count": 84}, "39.8897,115.275": {"count": 245}, "24.4798,118.0819": {"count": 37}, "30.011,120.5715": {"count": 69}, "39.1422,117.1767": {"count": 224}, "33.6957,73.0113": {"count": 1}, "45.75,126.65": {"count": 384}, "39.1068,-94.566": {"count": 15}, "55.7485,37.6184": {"count": 20}, "28.1792,113.1136": {"count": 433}, "22.5333,114.1333": {"count": 287}, "27.9994,120.6668": {"count": 189}, "36.0986,120.3719": {"count": 74}, "45.8696,-119.688": {"count": 57}, "36.6676,-78.3875": {"count": 62}, "51.2993,9.491": {"count": 1779}, "32.9,115.8167": {"count": 19}, "49.4478,11.0683": {"count": 312}, "41.8825,-87.6441": {"count": 23}, "-10.1667,123.5833": {"count": 2}, "28.55,115.9333": {"count": 22}, "31.5689,120.2886": {"count": 23}, "35.6427,139.7677": {"count": 28}, "32.8073,-117.1324": {"count": 5}, "22.2333,114.0": {"count": 340}, "30.5801,114.2734": {"count": 209}, "31.4478,121.0939": {"count": 9}, "23.7231,90.4086": {"count": 1}, "29.3151,120.0768": {"count": 287}, "50.4333,30.5167": {"count": 2}, "-22.8864,-43.2037": {"count": 24}, "22.291,114.15": {"count": 187}, "25.4833,103.7833": {"count": 31}, "40.4981,-74.3194": {"count": 23}, "52.2964,4.9541": {"count": 14}, "53.3389,-6.2595": {"count": 15}, "39.0728,114.8731": {"count": 13}, "41.8483,-87.6517": {"count": 4}, "22.3833,114.1833": {"count": 197}, "29.1068,119.6442": {"count": 23}, "-6.1744,106.8294": {"count": 160}, "37.5497,-121.9621": {"count": 19}, "37.5017,122.1136": {"count": 5}, "22.3614,112.6877": {"count": 15}, "39.0481,-77.4728": {"count": 201}, "25.0418,121.4966": {"count": 8}, "55.7522,37.6156": {"count": 2}, "50.6942,3.1746": {"count": 1}, "33.9058,-84.1803": {"count": 3}, "50.7167,-1.8833": {"count": 41}, "26.0614,119.3061": {"count": 49}, "32.0142,120.2625": {"count": 2}, "38.6582,-77.2497": {"count": 2}, "22.3167,114.2167": {"count": 33}, "38.9122,121.6022": {"count": 35}, "37.526,-122.3558": {"count": 60}, "34.0584,-118.278": {"count": 55}, "29.5628,106.5528": {"count": 51}, "37.7269,112.4708": {"count": 192}, "-7.1785,112.8978": {"count": 1}, "35.8569,139.6489": {"count": 3}, "41.0784,-104.7403": {"count": 2}, "23.4522,116.0922": {"count": 2}, "37.3422,-121.9052": {"count": 8}, "29.8782,121.5495": {"count": 107}, "50.1167,8.6833": {"count": 249}, "47.4891,-122.2908": {"count": 3}, "14.5955,120.9721": {"count": 2}, "37.5112,126.97409999999999": {"count": 6}, "1.2854999999999999,103.8565": {"count": 27}, "40.6152,-75.5437": {"count": 3}, "36.1113,-115.2791": {"count": 3}, "47.1449,8.1551": {"count": 3}, "37.4914,-122.211": {"count": 1}, "31.7833,119.9667": {"count": 57}, "43.8833,11.1": {"count": 40}, "-12.35,-38.3333": {"count": 1}, "43.877,-79.2578": {"count": 3}, "32.055,110.7342": {"count": 17}, "45.5,-73.5833": {"count": 4}, "53.3472,-6.2439": {"count": 6}, "38.7139,-9.1394": {"count": 3}, "34.1795,-117.2479": {"count": 1}, "34.1805,117.1571": {"count": 3}, "31.8639,117.2808": {"count": 41}, "50.7787,6.1085": {"count": 16}, "32.9729,119.5111": {"count": 11}, "32.4907,119.9081": {"count": 11}, "29.5958,120.8167": {"count": 11}, "49.1988,-123.1799": {"count": 2}, "47.6062,-122.3321": {"count": 5}, "34.5035,109.5089": {"count": 1}, "40.6522,109.8222": {"count": 7}, "30.7522,120.75": {"count": 3}, "42.2734,-83.7133": {"count": 12}, "41.1034,-104.9059": {"count": 1}, "41.45,2.2474": {"count": 20}, "17.3753,78.4744": {"count": 3}, "25.1072,117.0225": {"count": 1}, "40.7002,-111.9434": {"count": 6}, "43.6629,-79.3987": {"count": 8}, "37.8668,-122.2536": {"count": 1}, "35.438,-118.8312": {"count": 9}, "51.4964,-0.1224": {"count": 4}, "54.35,18.6667": {"count": 1}, "37.7353,-122.3732": {"count": 4}, "22.25,114.1667": {"count": 1}, "12.9833,77.5833": {"count": 1}, "22.8167,108.3167": {"count": 39}, "29.81,119.6711": {"count": 6}, "9.0,-80.0": {"count": 1}, "34.0494,-118.2641": {"count": 1}, "31.3041,120.5954": {"count": 7}, "-33.8229,151.0078": {"count": 5}, "52.35,4.9167": {"count": 1}, "22.4,113.9833": {"count": 3}, "22.3214,114.1726": {"count": 3}, "52.2794,4.7545": {"count": 5}, "48.7933,2.2927": {"count": 2}, "28.9594,118.8686": {"count": 2}, "37.3239,-121.9144": {"count": 7}, "52.3824,4.8995": {"count": 5}, "59.3247,18.056": {"count": 3}, "23.5711,102.0042": {"count": 2}, "51.3553,6.6366": {"count": 2}, "31.95,120.45": {"count": 2}, "35.69,139.69": {"count": 6}, "9.2389,98.9786": {"count": 1}, "13.7,100.4667": {"count": 3}, "45.3189,127.9583": {"count": 1}, "22.2769,113.5678": {"count": 4}, "50.6231,26.2274": {"count": 8}, "40.8326,-74.1307": {"count": 5}, "56.4,38.7167": {"count": 1}, "29.5135,104.4281": {"count": 10}, "-25.2833,-54.0833": {"count": 1}, "38.4681,106.2731": {"count": 3}, "49.2478,-122.9938": {"count": 3}, "44.825,13.8661": {"count": 1}, "23.0333,113.7167": {"count": 3}, "22.35,114.1833": {"count": 9}, "22.3667,114.1": {"count": 2}, "13.7667,100.65": {"count": 2}, "43.6872,-79.3368": {"count": 2}, "23.0512,112.4597": {"count": 3}, "33.6748,-111.9519": {"count": 22}, "34.147,-118.1392": {"count": 3}, "41.3888,2.159": {"count": 11}, "41.3984,2.1741": {"count": 6}, "43.3119,-1.9022999999999999": {"count": 7}, "52.5167,13.4": {"count": 2}, "-37.8103,144.9544": {"count": 37}, "23.0268,113.1315": {"count": 16}, "40.1,121.9833": {"count": 5}, "14.3869,120.8817": {"count": 1}, "-37.8286,145.0077": {"count": 4}, "-33.8794,151.2193": {"count": 4}, "-37.8139,144.9634": {"count": 4}, "-37.86,144.9717": {"count": 8}, "22.35,114.1333": {"count": 6}, "53.1772,-2.5334": {"count": 1}, "40.6678,114.4114": {"count": 5}, "-33.494,143.2104": {"count": 29}, "-42.8832,147.3317": {"count": 4}, "-27.471,153.0243": {"count": 5}, "-33.7912,151.1298": {"count": 13}, "31.3776,120.9543": {"count": 1}, "-27.5344,153.0246": {"count": 4}, "33.6751,-117.7339": {"count": 4}, "-37.8,145.0": {"count": 4}, "-37.75,145.0167": {"count": 9}, "55.6769,37.2731": {"count": 1}, "-35.2777,149.1183": {"count": 4}, "42.768299999999996,129.3364": {"count": 5}, "-33.95,151.0167": {"count": 2}, "-37.7833,144.9167": {"count": 4}, "-28.1358,153.4493": {"count": 3}, "-18.1333,178.4167": {"count": 1}, "-37.8825,145.0229": {"count": 4}, "-41.1769,146.3515": {"count": 4}, "-33.8178,151.0035": {"count": 1}, "-27.5833,153.1": {"count": 1}, "34.1379,-118.0259": {"count": 4}, "22.3333,114.25": {"count": 4}, "31.1461,118.5707": {"count": 51}, "22.4333,114.0333": {"count": 3}, "39.9653,-83.0235": {"count": 1}, "22.3333,114.15": {"count": 3}, "50.1153,8.6823": {"count": 1}, "-33.8612,151.1982": {"count": 18}, "32.957,-117.1979": {"count": 2}, "20.0458,110.3417": {"count": 3}, "38.9599,-77.3428": {"count": 9}, "45.504,-73.5747": {"count": 15}, "40.8596,-73.9314": {"count": 1}, "44.4333,26.1": {"count": 6}, "47.6344,-122.3422": {"count": 1}, "39.7351,-75.6684": {"count": 2}, "39.7157,-75.5281": {"count": 1}, "41.6005,-93.6091": {"count": 10}, "-37.8253,144.9522": {"count": 3}, "-29.0,24.0": {"count": 1}, "41.1078,121.1417": {"count": 1}, "32.3972,119.4358": {"count": 2}, "32.7787,-96.8217": {"count": 2}, "38.9841,-77.3827": {"count": 4}, "50.0549,72.9646": {"count": 1}, "29.5429,119.4991": {"count": 3}, "43.6555,-79.3626": {"count": 3}, "29.1231,110.1469": {"count": 27}, "28.8833,120.0333": {"count": 2}, "42.0156,121.6589": {"count": 3}, "46.0,105.0": {"count": 1}, "28.4604,119.9103": {"count": 1}, "38.9234,-121.0705": {"count": 2}, "27.776,120.6586": {"count": 7}, "21.0333,105.85": {"count": 1}, "28.2119,-80.7583": {"count": 1}, "37.4419,-122.143": {"count": 3}, "30.8703,120.0933": {"count": 18}, "-33.881,151.0799": {"count": 4}, "40.4167,-3.6837999999999997": {"count": 8}, "25.7806,-80.1826": {"count": 3}, "38.7701,-77.6321": {"count": 10}, "27.8456,120.4928": {"count": 1}, "22.5833,113.0833": {"count": 4}, "52.5772,-2.1079": {"count": 4}, "25.2819,110.2864": {"count": 2}, "40.5953,-74.6173": {"count": 4}, "26.5833,106.7167": {"count": 4}, "47.0188,28.8128": {"count": 3}, "-37.836,144.9183": {"count": 4}, "40.7082,-74.0132": {"count": 1}, "31.251,121.3897": {"count": 1}, "30.1675,120.2588": {"count": 1}, "48.9333,2.3667": {"count": 1}, "32.3219,118.2978": {"count": 1}, "24.0,54.0": {"count": 1}, "22.3167,114.1667": {"count": 1}, "13.4443,144.7863": {"count": 5}}

        // JSON数据格式转换
        function jsonTransform(posOriginJson) {
            let aGeoPosition = Object.keys(posOriginJson);
            let aCount = [];
            let arrGeoJoin = [];
            let arrGeo = [];
            let arrGeoTrans = [];
            let v;

            for ( v in posOriginJson) {
                aCount.push(posOriginJson[v]);
            }

            for (let i = 0; i < aGeoPosition.length; i++) {

                // 火星坐标系转百度坐标系
                arrGeoTrans.push(coordtransform.gcj02tobd09(parseFloat(aGeoPosition[i].split(',')[0]) , parseFloat(aGeoPosition[i].split(',')[1])));

            }

            for (let k = 0; k < arrGeoTrans.length; k++) {

                arrGeoJoin.push(arrGeoTrans[k].concat(aCount[k].count));
            }

            //console.log(arrGeoJoin)

            for (let j = 0; j < arrGeoJoin.length; j++) {
                arrGeo.push(new GeoPosition(...arrGeoJoin[j]));
            }
            return arrGeo;

            function GeoPosition(lat, lng, count) {
                this.lng = lng;
                this.lat = lat;
                this.count = count;
            }
        }

        let points = jsonTransform(posOriginJson);

        if(!isSupportCanvas()){
            alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
        }
        //详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
        //参数说明如下:
        /* visible 热力图是否显示,默认为true
         * opacity 热力的透明度,1-100
         * radius 势力图的每个点的半径大小
         * gradient  {JSON} 热力图的渐变区间 . gradient如下所示
         *	{
                .2:'rgb(0, 255, 255)',
                .5:'rgb(0, 110, 255)',
                .8:'rgb(100, 0, 255)'
            }
            其中 key 表示插值的位置, 0~1.
                value 为颜色值.
         */

        const heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":20});
        console.log(heatmapOverlay);

        map.addOverlay(heatmapOverlay);
        heatmapOverlay.setDataSet({data:points,max:100});

        //判断浏览区是否支持canvas
        function isSupportCanvas(){
            let elem = document.createElement('canvas');
            return !!(elem.getContext && elem.getContext('2d'));
        }
    }

    render () {
        return (
            <div>
                <div id='allmap' style={{
                    width:'100vw',
                    height:'100vh'
                }} />
            </div>
        )
    }
}
export default BaiduMap;